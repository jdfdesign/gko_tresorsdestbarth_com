/**
 * jQuery Cookie plugin
 *
 * Copyright (c) 2010 Klaus Hartl (stilbuero.de)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 */
jQuery.cookie=function(e,t,n){if(arguments.length>1&&String(t)!=="[object Object]"){n=jQuery.extend({},n);if(t===null||t===undefined)n.expires=-1;if(typeof n.expires=="number"){var r=n.expires,i=n.expires=new Date;i.setDate(i.getDate()+r)}return t=String(t),document.cookie=[encodeURIComponent(e),"=",n.raw?t:encodeURIComponent(t),n.expires?"; expires="+n.expires.toUTCString():"",n.path?"; path="+n.path:"",n.domain?"; domain="+n.domain:"",n.secure?"; secure":""].join("")}n=t||{};var s,o=n.raw?function(e){return e}:decodeURIComponent;return(s=(new RegExp("(?:^|; )"+encodeURIComponent(e)+"=([^;]*)")).exec(document.cookie))?o(s[1]):null},function(e){var t={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",resultsFormatter:function(e){return"<li>"+e[this.propertyToSearch]+"</li>"},tokenFormatter:function(e){return"<li><p>"+e[this.propertyToSearch]+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null},n={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},r={BEFORE:0,AFTER:1,END:2},i={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},s={init:function(n,r){var i=e.extend({},t,r||{});return this.each(function(){e(this).data("tokenInputObject",new e.TokenList(this,n,i))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(e){return this.data("tokenInputObject").add(e),this},remove:function(e){return this.data("tokenInputObject").remove(e),this},get:function(){return this.data("tokenInputObject").getTokens()}};e.fn.tokenInput=function(e){return s[e]?s[e].apply(this,Array.prototype.slice.call(arguments,1)):s.init.apply(this,arguments)},e.TokenList=function(t,s,o){function x(){if(o.tokenLimit!==null&&f>=o.tokenLimit){p.hide(),D();return}}function T(){if(h===(h=p.val()))return;var e=h.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");E.html(e),p.width(E.width()+30)}function N(e){return e>=48&&e<=90||e>=96&&e<=111||e>=186&&e<=192||e>=219&&e<=222}function C(t){var n=o.tokenFormatter(t);n=e(n).addClass(o.classes.token).insertBefore(b),e("<span>"+o.deleteText+"</span>").addClass(o.classes.tokenDelete).appendTo(n).click(function(){return M(e(this).parent()),d.change(),!1});var r={id:t.id};return r[o.propertyToSearch]=t[o.propertyToSearch],e.data(n.get(0),"tokeninput",t),a=a.slice(0,m).concat([r]).concat(a.slice(m)),m++,_(a,d),f+=1,o.tokenLimit!==null&&f>=o.tokenLimit&&(p.hide(),D()),n}function k(t){var n=o.onAdd;if(f>0&&o.preventDuplicates){var r=null;y.children().each(function(){var n=e(this),i=e.data(n.get(0),"tokeninput");if(i&&i.id===t.id)return r=n,!1});if(r){L(r),b.insertAfter(r),p.focus();return}}if(o.tokenLimit==null||f<o.tokenLimit)C(t),x();p.val(""),D(),e.isFunction(n)&&n.call(d,t)}function L(e){e.addClass(o.classes.selectedToken),v=e.get(0),p.val(""),D()}function A(e,t){e.removeClass(o.classes.selectedToken),v=null,t===r.BEFORE?(b.insertBefore(e),m--):t===r.AFTER?(b.insertAfter(e),m++):(b.appendTo(y),m=f),p.focus()}function O(t){var n=v;v&&A(e(v),r.END),n===t.get(0)?A(t,r.END):L(t)}function M(t){var n=e.data(t.get(0),"tokeninput"),r=o.onDelete,i=t.prevAll().length;i>m&&i--,t.remove(),v=null,p.focus(),a=a.slice(0,i).concat(a.slice(i+1)),i<m&&m--,_(a,d),f-=1,o.tokenLimit!==null&&p.show().val("").focus(),e.isFunction(r)&&r.call(d,n)}function _(t,n){var r=e.map(t,function(e){return e[o.tokenValue]});n.val(r.join(o.tokenDelimiter))}function D(){w.hide().empty(),g=null}function P(){w.css({position:"absolute",top:e(y).offset().top+e(y).outerHeight(),left:e(y).offset().left,zindex:999}).show()}function H(){o.searchingText&&(w.html("<p>"+o.searchingText+"</p>"),P())}function B(){o.hintText&&(w.html("<p>"+o.hintText+"</p>"),P())}function j(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function F(e,t,n){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","g"),j(t,n))}function I(t,n){if(n&&n.length){w.empty();var r=e("<ul>").appendTo(w).mouseover(function(t){q(e(t.target).closest("li"))}).mousedown(function(t){return k(e(t.target).closest("li").data("tokeninput")),d.change(),!1}).hide();e.each(n,function(n,i){var s=o.resultsFormatter(i);s=F(s,i[o.propertyToSearch],t),s=e(s).appendTo(r),n%2?s.addClass(o.classes.dropdownItem):s.addClass(o.classes.dropdownItem2),n===0&&q(s),e.data(s.get(0),"tokeninput",i)}),P(),o.animateDropdown?r.slideDown("fast"):r.show()}else o.noResultsText&&(w.html("<p>"+o.noResultsText+"</p>"),P())}function q(t){t&&(g&&R(e(g)),t.addClass(o.classes.selectedDropdownItem),g=t.get(0))}function R(e){e.removeClass(o.classes.selectedDropdownItem),g=null}function U(){var t=p.val().toLowerCase();t&&t.length&&(v&&A(e(v),r.AFTER),t.length>=o.minChars?(H(),clearTimeout(c),c=setTimeout(function(){z(t)},o.searchDelay)):D())}function z(t){var n=t+W(),r=l.get(n);if(r)I(t,r);else if(o.url){var i=W(),s={};s.data={};if(i.indexOf("?")>-1){var u=i.split("?");s.url=u[0];var a=u[1].split("&");e.each(a,function(e,t){var n=t.split("=");s.data[n[0]]=n[1]})}else s.url=i;s.data[o.queryParam]=t,s.type=o.method,s.dataType=o.contentType,o.crossDomain&&(s.dataType="jsonp"),s.success=function(r){e.isFunction(o.onResult)&&(r=o.onResult.call(d,r)),l.add(n,o.jsonContainer?r[o.jsonContainer]:r),p.val().toLowerCase()===t&&I(t,o.jsonContainer?r[o.jsonContainer]:r)},e.ajax(s)}else if(o.local_data){var f=e.grep(o.local_data,function(e){return e[o.propertyToSearch].toLowerCase().indexOf(t.toLowerCase())>-1});e.isFunction(o.onResult)&&(f=o.onResult.call(d,f)),l.add(n,f),I(t,f)}}function W(){var e=o.url;return typeof o.url=="function"&&(e=o.url.call()),e}if(e.type(s)==="string"||e.type(s)==="function"){o.url=s;var u=W();o.crossDomain===undefined&&(u.indexOf("://")===-1?o.crossDomain=!1:o.crossDomain=location.href.split(/\/+/g)[1]!==u.split(/\/+/g)[1])}else typeof s=="object"&&(o.local_data=s);o.classes?o.classes=e.extend({},n,o.classes):o.theme?(o.classes={},e.each(n,function(e,t){o.classes[e]=t+"-"+o.theme})):o.classes=n;var a=[],f=0,l=new e.TokenList.Cache,c,h,p=e('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",o.idPrefix+t.id).focus(function(){(o.tokenLimit===null||o.tokenLimit!==f)&&B()}).blur(function(){D(),e(this).val("")}).bind("keyup keydown blur update",T).keydown(function(t){var n,s;switch(t.keyCode){case i.LEFT:case i.RIGHT:case i.UP:case i.DOWN:if(!!e(this).val()){var o=null;return t.keyCode===i.DOWN||t.keyCode===i.RIGHT?o=e(g).next():o=e(g).prev(),o.length&&q(o),!1}n=b.prev(),s=b.next(),n.length&&n.get(0)===v||s.length&&s.get(0)===v?t.keyCode===i.LEFT||t.keyCode===i.UP?A(e(v),r.BEFORE):A(e(v),r.AFTER):t.keyCode!==i.LEFT&&t.keyCode!==i.UP||!n.length?(t.keyCode===i.RIGHT||t.keyCode===i.DOWN)&&s.length&&L(e(s.get(0))):L(e(n.get(0)));break;case i.BACKSPACE:n=b.prev();if(!e(this).val().length)return v?(M(e(v)),d.change()):n.length&&L(e(n.get(0))),!1;e(this).val().length===1?D():setTimeout(function(){U()},5);break;case i.TAB:case i.ENTER:case i.NUMPAD_ENTER:case i.COMMA:if(g)return k(e(g).data("tokeninput")),d.change(),!1;break;case i.ESCAPE:return D(),!0;default:String.fromCharCode(t.which)&&setTimeout(function(){U()},5)}}),d=e(t).hide().val("").focus(function(){p.focus()}).blur(function(){p.blur()}),v=null,m=0,g=null,y=e("<ul />").addClass(o.classes.tokenList).click(function(t){var n=e(t.target).closest("li");n&&n.get(0)&&e.data(n.get(0),"tokeninput")?O(n):(v&&A(e(v),r.END),p.focus())}).mouseover(function(t){var n=e(t.target).closest("li");n&&v!==this&&n.addClass(o.classes.highlightedToken)}).mouseout(function(t){var n=e(t.target).closest("li");n&&v!==this&&n.removeClass(o.classes.highlightedToken)}).insertBefore(d),b=e("<li />").addClass(o.classes.inputToken).appendTo(y).append(p),w=e("<div>").addClass(o.classes.dropdown).appendTo("body").hide(),E=e("<tester/>").insertAfter(p).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:p.css("fontSize"),fontFamily:p.css("fontFamily"),fontWeight:p.css("fontWeight"),letterSpacing:p.css("letterSpacing"),whiteSpace:"nowrap"});d.val("");var S=o.prePopulate||d.data("pre");o.processPrePopulate&&e.isFunction(o.onResult)&&(S=o.onResult.call(d,S)),S&&S.length&&e.each(S,function(e,t){C(t),x()}),e.isFunction(o.onReady)&&o.onReady.call(),this.clear=function(){y.children("li").each(function(){e(this).children("input").length===0&&M(e(this))})},this.add=function(e){k(e)},this.remove=function(t){y.children("li").each(function(){if(e(this).children("input").length===0){var n=e(this).data("tokeninput"),r=!0;for(var i in t)if(t[i]!==n[i]){r=!1;break}r&&M(e(this))}})},this.getTokens=function(){return a}},e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t),r={},i=0,s=function(){r={},i=0};this.add=function(e,t){i>n.max_size&&s(),r[e]||(i+=1),r[e]=t},this.get=function(e){return r[e]}}}(jQuery),function(e){e.extend(e.fn,{delayedObserver:function(t,n,r){return this.each(function(){var i=e(this),s=r||{};i.data("oldval",i.val()).data("delay",n||.5).data("condition",s.condition||function(){return e(this).data("oldval")==e(this).val()}).data("callback",t)[s.event||"keyup"](function(){if(i.data("condition").apply(i))return;i.data("timer")&&clearTimeout(i.data("timer")),i.data("timer",setTimeout(function(){i.data("callback").apply(i)},i.data("delay")*1e3)),i.data("oldval",i.val())})})}})}(jQuery),format_product_autocomplete=function(e){var t="",n=e.data.product;if(e.data["variant"]==undefined)n["images"].length!=0&&(t=image_html(n)),t+="<div><h4>"+n.title+"</h4>",t+="<span><strong>Sku: </strong>"+n.master.sku+"</span>",t+="<span><strong>On Hand: </strong>"+n.count_on_hand+"</span></div>";else{var r=e.data.variant,i=e.data.product.title;r["images"].length!=0?t=image_html(r):n["images"].length!=0&&(t=image_html(n)),i+=" - "+$.map(r.option_values,function(e){return e.option_type.presentation+": "+e.name}).join(", "),t+="<div><h4>"+i+"</h4>",t+="<span><strong>Sku: </strong>"+r.sku+"</span>",t+="<span><strong>On Hand: </strong>"+r.count_on_hand+"</span></div>"}return t},prep_product_autocomplete_data=function(data){return $.map(eval(data),function(e){var t=e.product;return t.variants.length>0&&["expand_variants"]?$.map(t.variants,function(e){var n=t.title;return n+=" - "+$.map(e.option_values,function(e){return e.option_type.presentation+": "+e.title}).join(", "),{data:{product:t,variant:e},value:title,result:title}}):{data:{product:t},value:t.title,result:t.title}})},$.fn.product_autocomplete=function(){return this.each(function(){$(this).autocomplete({source:function(e,t){$.get(ajax_urls.product_search_json+"?q="+$("#add_product_name").val()+"&authenticity_token="+encodeURIComponent($("meta[name=csrf-token]").attr("content")),function(e){result=prep_product_autocomplete_data(e),t(result)})},minLength:4,focus:function(e,t){return $("#add_product_name").val(t.item.label),!1},select:function(e,t){return $("#add_product_name").val(t.item.label),product=t.item.data,product["variant"]==undefined?$("#add_variant_id").val(product.product.master.id):$("#add_variant_id").val(product.variant.id),!1}}).data("autocomplete")._renderItem=function(e,t){return $(e).addClass("ac_results"),html=format_product_autocomplete(t),$("<li></li>").data("item.autocomplete",t).append("<a>"+html+"</a>").appendTo(e)},$(this).data("autocomplete")._resizeMenu=function(){var e=this.menu.element;e.outerWidth(this.element.outerWidth())}})},$.fn.objectPicker=function(e){$(this).tokenInput(e+"&authenticity_token="+escape(AUTH_TOKEN),{searchDelay:600,hintText:strings.type_to_search,noResultsText:strings.no_results,searchingText:strings.searching,prePopulateFromInput:!0})},$.fn.productPicker=function(){$(this).objectPicker(ajax_urls.product_search_basic_json)},$.fn.userPicker=function(){$(this).objectPicker(ajax_urls.user_search_basic_json)},$(document).ready(function(){$(".tokeninput.products").productPicker(),$(".tokeninput.users").userPicker()}),$(document).ready(function(){$.each($("td.qty input"),function(e,t){$(t).live("change",function(){var e="#"+$(this).attr("id").replace("_quantity","_id");jQuery.post("/admin/site/1/orders/"+$("input#order_number").val()+"/line_items/"+$(e).val(),{_method:"put","line_item[quantity]":$(this).val()},function(e){$("#order-form-wrapper").html(e.responseText)})})})}),$(document).ready(function(){add_address=function(e){var t="";return e!=undefined&&(t+=e.firstname+" "+e.lastname+", ",t+=e.address1+", "+e.address2+", ",t+=e.city+", ",e["state_id"]!=null?t+=e.state.name+", ":t+=e.state_name+", ",t+=e.country.name),t},format_user_autocomplete=function(e){var t=e.data,n="<h4>"+t.email+"</h4>";return n+="<span><strong>Billing:</strong> ",n+=add_address(t.bill_address),n+="</span>",n+="<span><strong>Shipping:</strong> ",n+=add_address(t.ship_address),n+="</span>",n},prep_user_autocomplete_data=function(data){return $.map(eval(data),function(e){return{data:e.user,value:e.user.email,result:e.user.email}})},$("#customer_search").length>0&&($("#customer_search").autocomplete({minChars:5,delay:1500,source:function(e,t){$.get(ajax_urls.user_search_json+"?q="+$("#customer_search").val()+"&authenticity_token="+encodeURIComponent($("meta[name=csrf-token]").attr("content")),function(e){result=prep_user_autocomplete_data(e),t(result)})},focus:function(e,t){return $("#customer_search").val(t.item.label),$(t).addClass("ac_over"),!1},select:function(e,t){return $("#customer_search").val(t.item.label),$.each(["bill","ship"],function(e,n){var r=t.item.data[n+"_address"];r!=undefined&&($("#order_"+n+"_address_attributes_firstname").val(r.firstname),$("#order_"+n+"_address_attributes_lastname").val(r.lastname),$("#order_"+n+"_address_attributes_company").val(r.company),$("#order_"+n+"_address_attributes_address1").val(r.address1),$("#order_"+n+"_address_attributes_address2").val(r.address2),$("#order_"+n+"_address_attributes_city").val(r.city),$("#order_"+n+"_address_attributes_zipcode").val(r.zipcode),$("#order_"+n+"_address_attributes_state_id").val(r.state_id),$("#order_"+n+"_address_attributes_country_id").val(r.country_id),$("#order_"+n+"_address_attributes_phone").val(r.phone))}),$("#order_email").val(t.item.data.email),$("#user_id").val(t.item.data.id),$("#guest_checkout_true").prop("checked",!1),$("#guest_checkout_false").prop("checked",!0),!0}}).data("autocomplete")._renderItem=function(e,t){return $(e).addClass("ac_results"),html=format_user_autocomplete(t),$("<li></li>").data("item.autocomplete",t).append("<a class='ui-menu-item'>"+html+"</a>").appendTo(e)},$("#customer_search").data("autocomplete")._resizeMenu=function(){var e=this.menu.element;e.outerWidth(this.element.outerWidth())}),$("input#order_use_ship_address").click(function(){show_billing(!$(this).is(":checked"))}),$("#guest_checkout_true").change(function(){$("#customer_search").val(""),$("#user_id").val(""),$("#checkout_email").val(""),$("#guest_checkout_false").prop("disabled",!0),$("#order_bill_address_attributes_firstname").val(""),$("#order_bill_address_attributes_lastname").val(""),$("#order_bill_address_attributes_company").val(""),$("#order_bill_address_attributes_address1").val(""),$("#order_bill_address_attributes_address2").val(""),$("#order_bill_address_attributes_city").val(""),$("#order_bill_address_attributes_zipcode").val(""),$("#order_bill_address_attributes_state_id").val(""),$("#order_bill_address_attributes_country_id").val(""),$("#order_bill_address_attributes_phone").val(""),$("#order_ship_address_attributes_firstname").val(""),$("#order_ship_address_attributes_lastname").val(""),$("#order_bill_address_attributes_company").val(""),$("#order_ship_address_attributes_address1").val(""),$("#order_ship_address_attributes_address2").val(""),$("#order_ship_address_attributes_city").val(""),$("#order_ship_address_attributes_zipcode").val(""),$("#order_ship_address_attributes_state_id").val(""),$("#order_ship_address_attributes_country_id").val(""),$("#order_ship_address_attributes_phone").val("")});var show_billing=function(e){e?($("#shipping").show(),$("#shipping input").prop("disabled",!1),$("#shipping select").prop("disabled",!1)):($("#shipping").hide(),$("#shipping input").prop("disabled",!0),$("#shipping select").prop("disabled",!0))}}),$(function(){var e=$("#gtwy-type").attr("value");$("div#gateway-settings-warning").hide(),$("#gtwy-type").change(function(){$("#gtwy-type").attr("value")==e?($("div.gateway-settings").show(),$("div#gateway-settings-warning").hide()):($("div.gateway-settings").hide(),$("div#gateway-settings-warning").show())})}),replace_ids=function(e){var t=(new Date).getTime();return e.replace(/NEW_RECORD/g,t)},$(function(){$("a[id*=nested]").click(function(){var template=$(this).attr("href").replace(/.*#/,"");html=replace_ids(eval(template)),$("#ul-"+$(this).attr("id")).append(html),update_remove_links()}),update_remove_links()});var update_remove_links=function(){$(".remove").click(function(){return $(this).prevAll(":first").val(1),$(this).parent().hide(),!1})};